<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Blockchain Certificate System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 40px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        .portal-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 30px; margin: 50px 0; }
        .portal-card {
            background: white; padding: 40px 30px; border-radius: 20px; text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; border: 3px solid transparent;
        }
        .portal-card:hover { transform: translateY(-10px); border-color: #667eea; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .portal-icon { font-size: 4rem; margin-bottom: 20px; }
        .portal-title { font-size: 1.8rem; margin-bottom: 15px; color: #2c3e50; }
        .portal-description { color: #666; margin-bottom: 25px; line-height: 1.6; }
        .portal-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;
            padding: 12px 30px; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
        }
        .portal-btn:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(102,126,234,0.3); }
        .content { display: none; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .content.active { display: block; }
        .back-btn {
            background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-size: 14px;
        }
        .back-btn:hover { background: #5a6268; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, select {
            width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s ease;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        .btn {
            background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color: white; border: none; padding: 12px 30px; border-radius: 8px;
            font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;
        }
        .btn:hover { transform: translateY(-2px); }
        .file-upload { border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; position: relative; }
        .file-upload:hover { border-color: #667eea; background: #f8f9fa; }
        .file-upload.dragover { border-color: #667eea; background: #e7f3ff; }
        .file-input { display: none; }
        .upload-icon { font-size: 2rem; color: #6c757d; margin-bottom: 10px; }
        .image-preview { max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px; display: none; border: 2px solid #dee2e6; }
        .file-info { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 0.9rem; }
        .file-name { font-weight: bold; color: #495057; }
        .file-size { color: #6c757d; font-size: 0.8rem; }
        .certificate-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 20px; margin-bottom: 15px; transition: all 0.3s ease; }
        .certificate-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .certificate-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
        .certificate-id { font-weight: bold; color: #667eea; font-size: 1.1rem; }
        .blockchain-badge { background: #28a745; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; }
        .image-badge { background: #17a2b8; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-left:5px; }
        .certificate-details p { margin:5px 0; color:#555; }
        .action-buttons { display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; justify-content:center; }
        .action-btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:0.9rem; transition: all 0.3s ease; text-decoration:none; display:inline-block; }
        .view-btn { background: #17a2b8; color: white; }
        .download-btn { background: #28a745; color: white; }
        .verify-btn { background: #ffc107; color: #212529; }
        .image-btn { background: #6f42c1; color: white; }
        .message { padding: 15px; border-radius:8px; margin:20px 0; text-align:center; font-weight:600; }
        .success { background: #d4edda; color:#155724; border:1px solid #c3e6cb; }
        .error { background: #f8d7da; color:#721c24; border:1px solid #f5c6cb; }
        .warning { background: #fff3cd; color:#856404; border:1px solid #ffeaa7; }
        .loading { text-align:center; padding:20px; color:#666; }
        .search-box { margin-bottom:20px; }
        .search-box input { max-width:400px; margin:0 auto; display:block; }
        .verification-image { max-width:400px; max-height:300px; border-radius:10px; border:3px solid #2c3e50; margin:20px auto; display:block; }
        .image-section { text-align:center; margin:20px 0; padding:20px; background:#f8f9fa; border-radius:10px; }
        .login-form { max-width:400px; margin:0 auto; background:white; padding:40px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
        .login-title { text-align:center; margin-bottom:30px; color:#2c3e50; }
        .feature-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin:30px 0; }
        .feature-card { background:#f8f9fa; padding:20px; border-radius:10px; text-align:center; border:2px solid #e9ecef; }
        .feature-icon { font-size:2rem; margin-bottom:10px; }
        .debug-info { background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius:8px; margin:15px 0; font-size:0.9rem; color:#856404; }
        .remove-file { background:#dc3545; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; font-size:0.8rem; margin-top:5px; }
        .portal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .logout-btn {
            background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;
            transition: all 0.3s ease;
        }
        .logout-btn:hover { background: #c82333; transform: translateY(-2px); }
        .clear-btn {
            background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px;
            transition: all 0.3s ease; margin-left: 10px;
        }
        .clear-btn:hover { background: #5a6268; transform: translateY(-2px); }
        .search-actions { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .config-section { background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .config-title { font-size: 1.2rem; margin-bottom: 15px; color: #2c3e50; }
        .config-input { margin-bottom: 15px; }
        .config-input label { display: block; margin-bottom: 5px; font-weight: 600; color: #495057; }
        .config-input input { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 5px; }
        .config-btn { background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
        .config-btn:hover { background: #138496; }
        .config-status { margin-top: 15px; padding: 10px; border-radius: 5px; font-size: 0.9rem; }
        .config-success { background: #d4edda; color: #155724; }
        .config-error { background: #f8d7da; color: #721c24; }
        .ip-display { background: #e9ecef; padding: 5px 10px; border-radius: 5px; font-family: monospace; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Configuration Modal (Only shows on first visit) -->
        <div id="configModal" class="content active">
            <div class="header">
                <h1>‚öôÔ∏è System Configuration</h1>
                <p>Configure your backend server connection</p>
            </div>

            <div class="config-section">
                <h3 class="config-title">Backend Server Configuration</h3>
                <p>Enter the IP address where your backend server is running.</p>
                
                <div class="config-input">
                    <label for="backendIP">Backend Server IP Address:</label>
                    <input type="text" id="backendIP" placeholder="e.g., 10.45.116.211">
                    <small>Leave blank for automatic detection (localhost:3000)</small>
                </div>
                
                <div class="config-input">
                    <label for="backendPort">Backend Server Port:</label>
                    <input type="text" id="backendPort" value="3000" placeholder="e.g., 3000">
                </div>
                
                <button class="btn" onclick="saveConfig()" style="width:100%; margin-top: 20px;">
                    üíæ Save Configuration & Continue
                </button>
                
                <div id="configStatus" class="config-status"></div>
                
                <div style="margin-top: 20px; padding: 15px; background: #e7f3ff; border-radius: 8px;">
                    <h4>üí° Help:</h4>
                    <p><strong>If backend is on the same machine:</strong> Leave IP blank or use "localhost"</p>
                    <p><strong>If backend is on another machine:</strong> Enter that machine's IP address</p>
                    <p><strong>To find backend IP:</strong> Run this on the backend machine:</p>
                    <div class="ip-display">hostname -I</div>
                    <p><strong>Current detected network IP:</strong></p>
                    <div id="detectedIP" class="ip-display">Detecting...</div>
                </div>
            </div>
        </div>

        <!-- Main Portal Selection -->
        <div id="mainPortal" class="content">
            <div class="header">
                <h1>WERXCFGVR</h1>
                <p>Connected to backend at: <span id="currentBackendUrl"></span></p>
                <button class="config-btn" onclick="showConfig()" style="margin-top: 10px;">‚öôÔ∏è Change Backend Settings</button>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">‚õìÔ∏è</div>
                    <h1>Blockchain Storage</h1>
                    <p>Certificates stored on Hyperledger Fabric</p>
                </div>
            </div>

            <div class="portal-grid">
                <div class="portal-card" onclick="showIssuerLogin()">
                    <div class="portal-icon">üéì</div>
                    <h2 class="portal-title">Issuer Portal</h2>
                    <p class="portal-description">For educational institutions and organizations to issue new certificates with secure image storage</p>
                    <button class="portal-btn">Access Issuer Portal</button>
                </div>

                <div class="portal-card" onclick="showReaderPortal()">
                    <div class="portal-icon">üîç</div>
                    <h2 class="portal-title">Reader Portal</h2>
                    <p class="portal-description">For students and employers to verify certificate authenticity and view original certificate images</p>
                    <button class="portal-btn">Access Reader Portal</button>
                </div>
            </div>
        </div>

        <!-- Issuer Login -->
        <div id="issuerLogin" class="content">
            <button class="back-btn" onclick="showMainPortal()">‚Üê Back to Main Portal</button>
            <div class="login-form">
                <h2 class="login-title">üéì Issuer Login</h2>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" required placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" required placeholder="Enter your password">
                </div>
                <button class="btn" onclick="loginIssuer()" style="width:100%;">Login to Issuer Portal</button>
            </div>
        </div>

        <!-- Issuer Portal -->
        <div id="issuer" class="content">
            <div class="portal-header">
                <button class="back-btn" onclick="showIssuerLogin()">‚Üê Back to Login</button>
                <button class="logout-btn" onclick="logoutIssuer()">üö™ Logout</button>
            </div>
            
            <h2>üéì Issue New Certificate</h2>
            <p><small>Backend: <span id="currentBackendUrlIssuer"></span></small></p>

            <form id="issueForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="certificateId">Certificate ID:</label>
                    <input type="text" id="certificateId" required placeholder="e.g., 23">
                    <small style="color:#666;">Enter a unique number like 23, 24, etc.</small>
                </div>
                <div class="form-group">
                    <label for="studentName">Student Name:</label>
                    <input type="text" id="studentName" required placeholder="Enter student full name">
                </div>
                <div class="form-group">
                    <label for="issuerName">Issuing Institution:</label>
                    <input type="text" id="issuerName" required placeholder="University/Organization name">
                    <small style="color:#666;">Enter the name of your institution</small>
                </div>
                <div class="form-group">
                    <label for="issueDate">Issue Date:</label>
                    <input type="date" id="issueDate" required>
                </div>

                <div class="form-group">
                    <label>Certificate Image (Required):</label>
                    <div class="file-upload" id="fileUploadArea">
                        <div class="upload-icon">üìÅ</div>
                        <p>Click to upload or drag & drop</p>
                        <p style="font-size:0.9rem; color:#6c757d;">PNG, JPG, GIF up to 10MB</p>
                        <input type="file" id="certificateImage" class="file-input" accept="image/*" required>
                        <img id="imagePreview" class="image-preview" alt="Image preview" />
                        <div id="fileInfo" class="file-info" style="display:none;">
                            <div class="file-name" id="fileName"></div>
                            <div class="file-size" id="fileSize"></div>
                            <button type="button" class="remove-file" onclick="removeSelectedFile()">Remove File</button>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn" style="width:100%;">üöÄ Issue Certificate on Blockchain</button>
            </form>

            <div id="issuerMessage"></div>
        </div>

        <!-- Reader Portal -->
        <div id="reader" class="content">
            <button class="back-btn" onclick="showMainPortal()">‚Üê Back to Main Portal</button>
            <h2>üîç Verify & View Certificates</h2>
            <p><small>Backend: <span id="currentBackendUrlReader"></span></small></p>

            <div class="search-box">
                <input type="text" id="searchCertificate" placeholder="Enter Certificate ID to verify (e.g., 22)">
                <div class="search-actions">
                    <button class="btn" onclick="verifyCertificate()">Verify Certificate</button>
                    <button class="clear-btn" onclick="clearReaderPage()">üóëÔ∏è Clear</button>
                </div>
            </div>

            <div id="verificationResult"></div>
        </div>
    </div>

    <script>
        // Configuration Management
        const CONFIG_KEY = 'blockchain_cert_config';
        
        // Default today's date
        const issueDateInput = document.getElementById('issueDate');
        if (issueDateInput) issueDateInput.valueAsDate = new Date();

        let selectedFile = null;
        let config = {
            backendIP: '',
            backendPort: '3000',
            autoDetected: false
        };

        // Initialize configuration
        function initConfig() {
            // Load saved configuration
            const savedConfig = localStorage.getItem(CONFIG_KEY);
            if (savedConfig) {
                config = JSON.parse(savedConfig);
            }
            
            // Detect current network IP for information
            detectNetworkIP();
            
            // If no saved config, show config modal
            if (!savedConfig) {
                showConfig();
            } else {
                updateBackendUrls();
                showMainPortal();
            }
        }

        // Detect network IP (for information only)
        function detectNetworkIP() {
            // This gets the client's IP, not the server's
            fetch('https://api.ipify.org?format=json')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('detectedIP').textContent = data.ip;
                })
                .catch(() => {
                    document.getElementById('detectedIP').textContent = 'Could not detect public IP';
                });
        }

        // Get backend base URL
        function getBackendUrl() {
            let ip = config.backendIP;
            const port = config.backendPort || '3000';
            
            if (!ip || ip.trim() === '') {
                // Default to localhost if no IP specified
                return `http://localhost:${port}`;
            }
            
            // Clean up IP address
            ip = ip.trim();
            if (!ip.startsWith('http://')) {
                ip = `http://${ip}`;
            }
            
            // Ensure port is included
            if (!ip.includes(':' + port) && !ip.endsWith(':' + port)) {
                // Remove any existing port
                ip = ip.replace(/:\d+$/, '');
                return `${ip}:${port}`;
            }
            
            return ip;
        }

        // Update backend URLs display
        function updateBackendUrls() {
            const backendUrl = getBackendUrl();
            document.getElementById('currentBackendUrl').textContent = backendUrl;
            document.getElementById('currentBackendUrlIssuer').textContent = backendUrl;
            document.getElementById('currentBackendUrlReader').textContent = backendUrl;
        }

        // Save configuration
        function saveConfig() {
            const ipInput = document.getElementById('backendIP');
            const portInput = document.getElementById('backendPort');
            const statusDiv = document.getElementById('configStatus');
            
            config.backendIP = ipInput.value.trim();
            config.backendPort = portInput.value.trim() || '3000';
            
            // Test the connection
            statusDiv.innerHTML = '<div class="loading">Testing connection to backend...</div>';
            
            const backendUrl = getBackendUrl();
            
            fetch(`${backendUrl}/api/test-blockchain`, { 
                method: 'GET',
                timeout: 5000 
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            })
            .then(data => {
                // Save configuration
                localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                updateBackendUrls();
                
                statusDiv.innerHTML = `<div class="config-success">‚úÖ Connected successfully! Backend is running at ${backendUrl}</div>`;
                
                // Hide config and show main portal after a delay
                setTimeout(() => {
                    hideAllContent();
                    document.getElementById('mainPortal').classList.add('active');
                }, 1500);
            })
            .catch(error => {
                statusDiv.innerHTML = `<div class="config-error">‚ùå Connection failed: ${error.message}</div>`;
                
                // Ask if they want to save anyway
                setTimeout(() => {
                    if (confirm('Connection test failed. Do you want to save the configuration anyway?')) {
                        localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
                        updateBackendUrls();
                        hideAllContent();
                        document.getElementById('mainPortal').classList.add('active');
                    }
                }, 1000);
            });
        }

        // Show configuration
        function showConfig() {
            hideAllContent();
            document.getElementById('configModal').classList.add('active');
            
            // Load current config into inputs
            document.getElementById('backendIP').value = config.backendIP;
            document.getElementById('backendPort').value = config.backendPort;
        }

        // Navigation
        function hideAllContent() {
            document.querySelectorAll('.content').forEach(tab => tab.classList.remove('active'));
        }
        function showMainPortal() { 
            hideAllContent(); 
            document.getElementById('mainPortal').classList.add('active'); 
        }
        function showIssuerLogin() { 
            hideAllContent(); 
            document.getElementById('issuerLogin').classList.add('active'); 
        }
        function showIssuerPortal() { 
            hideAllContent(); 
            document.getElementById('issuer').classList.add('active'); 
        }
        function showReaderPortal() { 
            hideAllContent(); 
            document.getElementById('reader').classList.add('active'); 
        }

        // Logout function
        function logoutIssuer() {
            // Clear any form data
            document.getElementById('certificateId').value = '';
            document.getElementById('studentName').value = '';
            document.getElementById('issuerName').value = '';
            document.getElementById('issueDate').valueAsDate = new Date();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            selectedFile = null;
            
            // Clear any messages
            document.getElementById('issuerMessage').innerHTML = '';
            
            // Show logout confirmation
            alert('You have been logged out successfully.');
            
            // Return to main portal
            showMainPortal();
        }

        // Clear reader page function
        function clearReaderPage() {
            // Clear search input
            document.getElementById('searchCertificate').value = '';
            
            // Clear verification result
            document.getElementById('verificationResult').innerHTML = '';
            
            // Show confirmation message
            const resultDiv = document.getElementById('verificationResult');
            resultDiv.innerHTML = '<div class="success">‚úÖ Page cleared successfully. Ready for new verification.</div>';
            
            // Auto-clear the message after 2 seconds
            setTimeout(() => {
                if (resultDiv.innerHTML.includes('Page cleared successfully')) {
                    resultDiv.innerHTML = '';
                }
            }, 2000);
        }

        // File upload setup
        function setupFileUpload() {
            const fileInput = document.getElementById('certificateImage');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInfo = document.getElementById('fileInfo');
            const fileName = document.getElementById('fileName');
            const fileSize = document.getElementById('fileSize');
            const imagePreview = document.getElementById('imagePreview');

            // Click area to trigger file input
            fileUploadArea.addEventListener('click', (e) => {
                if (e.target !== fileInfo && !e.target.classList.contains('remove-file')) {
                    fileInput.click();
                }
            });

            // Drag/drop
            fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
            fileUploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); fileUploadArea.classList.remove('dragover'); });
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) handleFileSelect(e.dataTransfer.files[0]);
            });

            // Change event
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) handleFileSelect(e.target.files[0]);
            });

            function handleFileSelect(file) {
                if (!file.type.startsWith('image/')) {
                    alert('‚ùå Please select an image file (PNG, JPG, GIF, etc.)');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    alert('‚ùå File size must be less than 10MB');
                    return;
                }
                selectedFile = file;
                fileName.textContent = file.name;
                fileSize.textContent = `Size: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
                fileInfo.style.display = 'block';

                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    imagePreview.style.display = 'none';
                }
                console.log('‚úÖ File selected:', file.name, `(${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            }
        }

        function removeSelectedFile() {
            document.getElementById('certificateImage').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('fileInfo').style.display = 'none';
            selectedFile = null;
        }

        // Login (demo)
        function loginIssuer() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === 'admin' && password === 'admin123') {
                showIssuerPortal();
            } else {
                alert('Invalid credentials. Use: admin / admin123');
            }
        }

        // Form submit
        document.getElementById('issueForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const certificateId = document.getElementById('certificateId').value.trim();
            const studentName = document.getElementById('studentName').value.trim();
            const issuerInput = document.getElementById('issuerName');
            const institutionName = issuerInput ? issuerInput.value.trim() : '';
            const issueDateValue = document.getElementById('issueDate').value;

            const messageDiv = document.getElementById('issuerMessage');
            messageDiv.innerHTML = '';

            if (!institutionName) {
                messageDiv.innerHTML = `<div class="error">‚ùå Please enter the institution name</div>`;
                return;
            }
            if (!selectedFile) {
                messageDiv.innerHTML = `<div class="error">‚ùå Please select a certificate image to upload</div>`;
                return;
            }

            messageDiv.innerHTML = '<div class="loading">‚è≥ Uploading image to IPFS and issuing certificate on blockchain...</div>';

            try {
                const backendUrl = getBackendUrl();
                const formData = new FormData();
                formData.append('certificateId', certificateId);
                formData.append('studentName', studentName);
                formData.append('issuer', institutionName);
                formData.append('issueDate', issueDateValue);
                formData.append('certificateImage', selectedFile);

                const response = await fetch(`${backendUrl}/api/certificates`, {
                    method: 'POST', 
                    body: formData
                });

                const result = await response.json();
                console.log('Server Response:', result);

                if (response.ok) {
                    let message = `‚úÖ Certificate issued successfully!<br>
                        <strong>Certificate ID:</strong> ${result.certificateId || certificateId}<br>
                        <strong>Student:</strong> ${result.studentName || studentName}<br>
                        <strong>Issuer:</strong> ${result.issuer || institutionName}<br>
                        <strong>IPFS Hash:</strong> ${result.imageIpfsHash || 'N/A'}<br>
                        ‚úì Stored on Hyperledger Fabric Blockchain`;

                    if (result.imageUploaded) message += `<br>üñºÔ∏è Image uploaded to IPFS and hash stored on blockchain`;

                    messageDiv.innerHTML = `<div class="success">${message}</div>`;

                    // clear form fields
                    document.getElementById('certificateId').value = '';
                    document.getElementById('studentName').value = '';
                    document.getElementById('issueDate').valueAsDate = new Date();
                    document.getElementById('imagePreview').style.display = 'none';
                    document.getElementById('fileInfo').style.display = 'none';
                    selectedFile = null;

                    // Auto-verify the created certificate if server returned id
                    if (result.certificateId) {
                        setTimeout(() => verifySpecificCertificate(result.certificateId), 2000);
                    }
                } else {
                    messageDiv.innerHTML = `<div class="error">‚ùå Server Error: ${result.error || 'Unknown server error'}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        });

        // Verification
        async function verifyCertificate() {
            const certId = document.getElementById('searchCertificate').value.trim();
            if (!certId) { 
                const resultDiv = document.getElementById('verificationResult');
                resultDiv.innerHTML = '<div class="warning">‚ö†Ô∏è Please enter a Certificate ID to verify</div>';
                return; 
            }
            await verifySpecificCertificate(certId);
        }

        async function verifySpecificCertificate(certificateId) {
            const resultDiv = document.getElementById('verificationResult');
            resultDiv.innerHTML = '<div class="loading">‚è≥ Verifying on blockchain...</div>';

            try {
                const backendUrl = getBackendUrl();
                const response = await fetch(`${backendUrl}/api/verify/${certificateId}`);
                const result = await response.json();
                console.log('Verification Result:', result);

                if (result.verified) {
                    let imageSection = '';
                    if (result.imageIpfsHash && result.imageUrl) {
                        imageSection = `
                            <div class="image-section">
                                <h4>üì∑ Certificate Image (Stored on IPFS)</h4>
                                <img src="${result.imageUrl}" alt="Certificate Image" class="verification-image" onerror="this.style.display='none'">
                                <div style="margin-top:10px;">
                                    <strong>IPFS Hash:</strong> ${result.imageIpfsHash}<br>
                                    <small>This image was uploaded by the issuer and stored on IPFS</small>
                                </div>
                                <button class="action-btn image-btn" onclick="viewImage('${result.imageIpfsHash}')" style="margin-top:10px;">Open Image in New Tab</button>
                            </div>
                        `;
                    }

                    resultDiv.innerHTML = `<div class="success">
                        ‚úÖ CERTIFICATE VERIFIED<br><br>
                        <strong>Certificate ID:</strong> ${result.certificateId}<br>
                        <strong>Student Name:</strong> ${result.studentName}<br>
                        <strong>Issuer:</strong> ${result.issuer}<br>
                        <strong>Issue Date:</strong> ${result.issueDate}<br>
                        <strong>Verified At:</strong> ${new Date(result.timestamp).toLocaleString()}
                        ${imageSection}<br><br>
                        <span class="blockchain-badge">‚úì Stored on Hyperledger Fabric</span>
                        <div class="action-buttons" style="margin-top:15px;">
                            ${result.imageIpfsHash ? `<button class="action-btn image-btn" onclick="viewImage('${result.imageIpfsHash}')">View Image</button>` : ''}
                        </div>
                    </div>`;
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        ‚ùå CERTIFICATE NOT FOUND<br><br>
                        Certificate <strong>${certificateId}</strong> is not registered on the blockchain.<br>
                        This certificate may be fraudulent or not yet issued.
                    </div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Verification error: ${error.message}</div>`;
            }
        }

        // Open IPFS image in new tab
        function viewImage(ipfsHash) {
            if (!ipfsHash) return;
            const backendUrl = getBackendUrl();
            const ipfsBase = backendUrl.replace(':3000', ':8081');
            window.open(`${ipfsBase}/ipfs/${ipfsHash}`, '_blank');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            initConfig();
        });
    </script>
</body>
</html>
